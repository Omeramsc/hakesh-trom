{% extends "base_layout.html" %}

{% block header %}
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta charset="utf-8"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/loading-spinner.css') }}"/>
{% endblock %}

{% block layout %}
    <div id="subtitle_container">
        <h3 class="route-builder-team-title">ניהול מסלול</h3>
    </div>
    <main id="main_layout" class="unified_layout route-builder">
        <div class="route-builder-team-panel">
            <button type="button" class="btn btn-info route-builder-team-panel__save-btn" id="save-button">שמור</button>
            {% for team in neighborhood_teams %}
                <div class="route-builder-team-panel__team" data-id="{{ team['id'] }}" id="team-{{ team['id'] }}">
                <span class="route-builder-team-panel__team_title">
                    <span class="h3">
                        צוות {{ team['id'] }}
                    </span>
                    {% if not team['buildings'] %}
                        <span class="route-builder-team-panel__team_title__no_route">!</span>
                    {% endif %}
                </span>
                    <div class="route-builder-team-panel__team_route collapse">
                        {% if team['buildings'] %}
                            <ul>
                                {% for building in team['buildings'] %}
                                    <li>
                                        {{ building['address'] }} - צפי: {{ building['predicted_earnings'] }}
                                    </li>
                                {% endfor %}
                            </ul>
                            <span><b>סה"כ צפי רווח</b>:
                            {{ team['predicted_total'] }}
                            </span>
                        {% else %}
                            לא נבחר מסלול
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="route-builder-map-panel" id="map">
        </div>
        <div class="hidden"></div>
    </main>
    <script>
        // Building colors
        const NOT_AVAILABLE_COLOR = '#a2a4a6';
        const PICKED_TEAM_COLOR = '#4287f5';
        const ABOVE_AVG_COLOR = '#55eb34';
        const AVG_COLOR = '#eef207';
        const BELLOW_AVG_COLOR = '#FF0000';
        const AVG_BIAS = 5;

        const teamELms = document.getElementsByClassName('route-builder-team-panel__team');
        const saveButtonElm = document.getElementById('save-button');
        const buildings = {{ neighborhood_buildings | tojson  }};
        const neighborhood =  {{ neighborhood_data | tojson }};
        const _teams = {{ neighborhood_teams | tojson }};
        const teams = _teams.map(t => ({...t, buildingIds: t.buildings.map(b => b.id)}));
        const avgPredictedEarnings = Math.floor(buildings.reduce((accumulator, currentValue) => accumulator + currentValue.predicted_earnings, 0) / buildings.length);
        saveButtonElm.disabled = true;
        saveButtonElm.addEventListener('click', saveChanges);

        // check if should prevent the user to exit the tab if there are any unsaved changes
        window.onbeforeunload = () => {
            if (teams.some(t => t.unclean)) return true;

            return;
        };

        let selectedTeamId;
        let buildingLayerByTeamId = {};
        let selectedTeamBuildings = [];

        function convertPointToLatLng(point) {
            return {
                lng: point[0],
                lat: point[1]
            }
        }

        function updateTeamId(newTeamId) {
            if (!buildingLayerByTeamId[newTeamId]) buildingLayerByTeamId[newTeamId] = [];

            if (selectedTeamId) {
                // Preforming clean up
                for (const polygon of buildingLayerByTeamId[selectedTeamId]) {
                    polygon.setOptions({'fillColor': NOT_AVAILABLE_COLOR, strokeColor: NOT_AVAILABLE_COLOR})
                }
            }

            selectedTeamId = newTeamId

            // Color the buildings of the team
            for (const polygon of buildingLayerByTeamId[newTeamId]) {
                polygon.setOptions({'fillColor': PICKED_TEAM_COLOR, strokeColor: PICKED_TEAM_COLOR})
            }
        }

        function closeAllRoutes() {
            return new Promise((resolve) => {
                $('.route-builder-team-panel__team_route').on('hidden.bs.collapse', function () {
                    resolve();
                })
            })
        }

        for (const teamElm of teamELms) {
            teamElm.addEventListener('click', async function () {
                const newSelectedTeamId = parseInt(this.getAttribute('data-id'), 10);

                if (newSelectedTeamId === selectedTeamId) {
                    return;
                }

                // Reset all the other teams
                for (const teamElm of teamELms) {
                    teamElm.classList.remove('route-builder-team-panel__team__selected')
                }
                // Turn on the selected team
                this.classList.add('route-builder-team-panel__team__selected')

                const routeElm = $(this).find('.route-builder-team-panel__team_route')

                if (selectedTeamId) {
                    // Close all the other routes
                    const closeAllRoutesOtherRoutes = closeAllRoutes()
                    $('.route-builder-team-panel__team_route').collapse('hide');
                    // Waiting for the close animation to close
                    await closeAllRoutesOtherRoutes;
                }

                // Open route for the selected team
                routeElm.collapse('show');

                // Update the selected team ID
                updateTeamId(newSelectedTeamId)
            })
        }

        function showLoading(parent) {
            parent.innerHTML = '<div id="modal-content" style="text-align: center;direction: rtl;"><h3>שומר...</h3><div class="lds-dual-ring"></div>';
            $('#modal-content').modal({
                escapeClose: false,
                clickClose: false,
                showClose: false
            })
        }

        function showError() {
            $.modal.getCurrent().$elm[0].innerHTML = "<h3>אופס...</h3><div>התרחשה שגיאה, אנא נסה/י שוב במעוד מאוחר יותר</div><a href='#close' rel='modal:close'><button class='btn btn-secondary'>סגור</button></a>";
            $('#modal-content').modal({
                escapeClose: true,
                clickClose: true,
                showClose: false
            })
        }

        function showSuccess() {
            $.modal.getCurrent().$elm[0].innerHTML = "<h3>המסלולים נשמרו!</h3><div>המסלולים נשמרו בהצלחה!</div><a href='#close' rel='modal:close'><button class='btn btn-secondary'>סגור</button></a>";
            $('#modal-content').modal({
                escapeClose: true,
                clickClose: true,
                showClose: false
            })
        }


        async function saveChanges() {
            const csrfToken = "{{ csrf_token() }}";
            const url = "{{ url_for('upsert_routes', campaign_id=campaign_id, neighborhood_id=neighborhood_id) }}";
            const unsavedTeams = teams.filter(t => t.unclean);
            const parsedUpdate = unsavedTeams.reduce((accumulator, currentValue) => {
                accumulator[currentValue.id] = [...currentValue.buildingIds];
                return accumulator;
            }, {});

            const modalContentPlaceholder = document.getElementsByClassName('hidden')[0]
            showLoading(modalContentPlaceholder);

            try {
                // Excute the API call
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify(parsedUpdate) // body data type must match "Content-Type" header
                });

                if (response.ok) {
                    for (const team of unsavedTeams) {
                        team.unclean = false;
                        renderTeamRoute(team);
                    }
                    showSuccess();
                    return;
                }

                // Throw an error if we got a bad response fron the BE
                throw new Error(`Got ${response.statusText} (${response.status}) response`);
            } catch (e) {
                // There is an error :(
                console.error(e);
                showError();
            }
        }

        function checkAndRenderNoRouteIndicator(teamDiv) {
            const titleElm = teamDiv.getElementsByClassName('route-builder-team-panel__team_title')[0];
            let noRouteElm = titleElm.getElementsByClassName("route-builder-team-panel__team_title__no_route")[0];
            if (!noRouteElm) {
                // Adding the no route element
                noRouteElm = document.createElement('span');
                noRouteElm.classList.add('route-builder-team-panel__team_title__no_route');
                noRouteElm.innerText = '!';
                titleElm.appendChild(noRouteElm);
            }
        }

        function removeNoRouteIndicator(teamDiv) {
            const titleElm = teamDiv.getElementsByClassName('route-builder-team-panel__team_title')[0];
            const noRouteElm = titleElm.getElementsByClassName("route-builder-team-panel__team_title__no_route")[0];
            if (noRouteElm) {
                noRouteElm.remove()
            }
        }

        function addUncleanIndicator(teamDiv) {
            const titleElm = teamDiv.getElementsByClassName('route-builder-team-panel__team_title')[0];
            let uncleanElm = titleElm.getElementsByClassName("route-builder-team-panel__team_title__unclean")[0];
            if (!uncleanElm) {
                // Adding the unclean element
                uncleanElm = document.createElement('span');
                uncleanElm.classList.add('route-builder-team-panel__team_title__unclean');
                uncleanElm.innerText = '•';
                titleElm.appendChild(uncleanElm)
            }
        }

        function removeUncleanIndicator(teamDiv) {
            const titleElm = teamDiv.getElementsByClassName('route-builder-team-panel__team_title')[0];
            const uncleanElm = titleElm.getElementsByClassName("route-builder-team-panel__team_title__unclean")[0];
            if (uncleanElm) {
                uncleanElm.remove()
            }
        }

        function renderTeamRoute(team) {
            const teamDiv = document.getElementById(`team-${team.id}`);
            const teamRouteDiv = teamDiv.getElementsByClassName("route-builder-team-panel__team_route")[0];

            // Update the save button - if there are at least 1 team that is unsaved, make the button enabled
            saveButtonElm.disabled = !teams.some(t => t.unclean);

            if (team.unclean) {
                addUncleanIndicator(teamDiv)
            } else {
                removeUncleanIndicator(teamDiv);
            }

            if ((team.buildings || []).length === 0) {
                teamRouteDiv.innerText = 'לא נבחר מסלול';
                checkAndRenderNoRouteIndicator(teamDiv);
                return;
            }
            removeNoRouteIndicator(teamDiv);


            // Cleanup the div
            teamRouteDiv.innerHTML = '';
            let totalPredictedEarnings = 0;

            // Adding the route list
            const routeUL = document.createElement('ul');
            for (const building of team.buildings) {
                const buildingLi = document.createElement('li');
                buildingLi.innerText = `${building.address} - צפי: ${building.predicted_earnings}`;
                routeUL.appendChild(buildingLi)
                totalPredictedEarnings += building.predicted_earnings;
            }
            teamRouteDiv.appendChild(routeUL);

            // Adding to total predicted_earnings
            const totalPredictedEarningsSpan = document.createElement('span');
            totalPredictedEarningsSpan.innerHTML = `<b>סה"כ צפי רווח</b>: ${totalPredictedEarnings.toFixed(2)}`;
            teamRouteDiv.appendChild(totalPredictedEarningsSpan);
        }

        function createAddBuildingToRouteButton(building, polygon, infoWindow) {
            const addBuildingToRoute = document.createElement('button');
            addBuildingToRoute.innerText = "הוסף למסלול";
            addBuildingToRoute.classList.add('btn', 'btn-primary');
            addBuildingToRoute.disabled = !Boolean(selectedTeamId)
            addBuildingToRoute.addEventListener('click', () => {
                const selectedTeam = teams.find(t => t.id === selectedTeamId);

                // Adding the building
                selectedTeam.buildingIds.push(building.id);
                selectedTeam.buildings.push(building);

                // Marking the team with as unclean
                selectedTeam.unclean = true;

                // Color the polygon
                polygon.setOptions({'fillColor': PICKED_TEAM_COLOR, strokeColor: PICKED_TEAM_COLOR});

                // Update the team list
                renderTeamRoute(selectedTeam);

                infoWindow.close();
            });

            return addBuildingToRoute;
        }

        function createDeleteBuildingFromRouteButton(building, polygon, infoWindow) {
            const deleteBuildingFromRoute = document.createElement('button');
            deleteBuildingFromRoute.innerText = "מחק מהמסלול";
            deleteBuildingFromRoute.classList.add('btn', 'btn-danger');
            deleteBuildingFromRoute.disabled = !Boolean(selectedTeamId)
            deleteBuildingFromRoute.addEventListener('click', () => {
                const selectedTeam = teams.find(t => t.id === selectedTeamId);

                // Remove the building
                selectedTeam.buildingIds = selectedTeam.buildingIds.filter(b => b !== building.id);
                selectedTeam.buildings = selectedTeam.buildings.filter(b => b.id !== building.id);

                // Marking the team with as unclean
                selectedTeam.unclean = true;

                // Color the polygon
                polygon.setOptions({
                    'fillColor': calculatePolygonColor(building, null),
                    strokeColor: calculatePolygonColor(building, null)
                });

                // Update the team list
                renderTeamRoute(selectedTeam);

                infoWindow.close();
            });

            return deleteBuildingFromRoute;
        }

        function generateInfoWindowContent(building, polygon, infoWindow) {
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('route-builder-map__info_window');

            const addressSpan = document.createElement('span');
            addressSpan.innerHTML = `<u><b>כתובת</b></u>:${building.address}`;
            contentDiv.appendChild(addressSpan);

            const numberOfFloorsSpan = document.createElement('span');
            numberOfFloorsSpan.innerHTML = `<u><b>מספר קומות</b></u>: ${building.number_of_floors}`;
            contentDiv.appendChild(numberOfFloorsSpan);

            const predictedEarningsSpan = document.createElement('span');
            predictedEarningsSpan.innerHTML = `<u><b>צפי רווח</b></u>: ${building.predicted_earnings}`;
            contentDiv.appendChild(predictedEarningsSpan);

            if (selectedTeamId) {
                const teamIdOfBuildingInRoute = (teams.find(t => t.buildingIds.includes(building.id)) || {}).id;

                if (selectedTeamId === teamIdOfBuildingInRoute) {
                    // The selected team is the ones who have this building in the route
                    contentDiv.appendChild(createDeleteBuildingFromRouteButton(building, polygon, infoWindow))
                } else {
                    contentDiv.appendChild(createAddBuildingToRouteButton(building, polygon, infoWindow));
                }
            }

            return contentDiv;
        }

        function addPolygon(map, infoWindow, building) {
            const teamForBuilding = teams.find(t => t.buildingIds.includes(building.id));

            const polygon = new google.maps.Polygon({
                fillOpacity: 0.38,
                map,
                building,
                paths: building.geometry.map(convertPointToLatLng),
                strokeOpacity: 0.8,
                strokeWeight: 2,
                strokeColor: calculatePolygonColor(building, teamForBuilding),
                fillColor: calculatePolygonColor(building, teamForBuilding),
            });

            google.maps.event.addListener(polygon, "click", function (event) {
                infoWindow.setPosition(event.latLng);
                infoWindow.open(map);

                infoWindow.setContent(generateInfoWindowContent(building, polygon, infoWindow));
            });

            if (teamForBuilding) {
                // Initing the layer
                if (!buildingLayerByTeamId[teamForBuilding.id]) buildingLayerByTeamId[teamForBuilding.id] = []

                buildingLayerByTeamId[teamForBuilding.id].push(polygon)
            }
        }

        function calculatePolygonColor(building, teamForBuilding) {
            if (teamForBuilding) {
                return NOT_AVAILABLE_COLOR;
            }

            if (building.predicted_earnings > avgPredictedEarnings + AVG_BIAS) {
                return ABOVE_AVG_COLOR;
            }

            if (building.predicted_earnings >= avgPredictedEarnings - AVG_BIAS && building.predicted_earnings <= avgPredictedEarnings + AVG_BIAS) {
                return AVG_COLOR;
            }

            return BELLOW_AVG_COLOR;
        }

        function initMap() {
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 16,
                center: convertPointToLatLng(neighborhood.center_point),
                mapTypeId: "terrain"
            });

            const neighborhoodPolygon = new google.maps.Polygon({
                map,
                paths: neighborhood.geometry.map(convertPointToLatLng),
                fillOpacity: 0,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                strokeColor: "#FF0000",
                fillColor: "#FF0000"
            });

            const infoWindow = new google.maps.InfoWindow({
                size: new google.maps.Size(150, 50)
            });

            google.maps.event.addListener(map, "click", function () {
                infoWindow.close();
            });

            for (const building of buildings) {
                addPolygon(map, infoWindow, building);
            }
        }
    </script>

    <script
            async
            defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCeQSgOmTLHNxGk4Vg3JlTNCGD8BEO992Y&callback=initMap&libraries=visualization">
    </script>

{% endblock %}